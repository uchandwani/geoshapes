<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Time Report</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; }
    th { background: #f4f4f4; }
  </style>
</head>
<body>
  <h2>Student Time Summary</h2>
  <table id="report-table">
    <thead>
      <tr>
        <th>Student ID</th>
        <th>Total Time (mins)</th>
        <th>Attempts</th>
        <th>Topics Attempted</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script type="module">

import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js';
import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js';
import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js';

 const firebaseConfig = {
    apiKey: "AIzaSyD9iKzQKtP1Yqsd_4vwluzrfPGGvuJythY",
    authDomain: "geoshapes-b267a.firebaseapp.com",
    projectId: "geoshapes-b267a",
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);  // ‚úÖ Use after app is defined
//  signInAnonymously(auth).catch(console.error);
  
  async function generateReport() {
  const db = getFirestore();
  const snapshot = await getDocs(collection(db, "progress"));
  const report = {};

  if (snapshot.empty) {
    console.warn("‚ö†Ô∏è No documents found in 'progress' collection.");
    return;
  }

  for (const docSnap of snapshot.docs) {
    const d = docSnap.data();
    const uid = d.uid || d.studentId || "unknown";

    if (typeof d.timeTaken === "number" && d.timeTaken > 0) {
      if (!report[uid]) {
        report[uid] = { totalTime: 0, attempts: 0, topics: [] };
      }

      report[uid].totalTime += d.timeTaken;
      report[uid].attempts += 1;
      report[uid].topics.push(`${d.topicId} [${d.subtopicId}]`);
    }
  }

  const tbody = document.querySelector("#report-table tbody");

  for (const [uid, data] of Object.entries(report)) {
    // üß† Fetch name from users collection using uid
    let userName = uid;
    try {
      const userSnap = await getDoc(doc(db, "users", uid));
      if (userSnap.exists()) {
        const userData = userSnap.data();
        userName = userData.name || userData.email || uid;
      }
    } catch (err) {
      console.warn(`‚ùå Failed to fetch user info for UID ${uid}`, err);
    }

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${userName}</td>
      <td>${Math.round(data.totalTime / 60)} min</td>
      <td>${data.attempts}</td>
      <td>${data.topics.join("<br>")}</td>
    `;
    tbody.appendChild(row);
  }
}

generateReport();

</script>

</body>
</html>
